<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Boarding House</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="security.js"></script>
</head>
<body>

    <section id="admin-login" class="active-screen">
        <div class="login-card">
            <h1>Admin Access</h1>
            <input type="password" id="admin-pass" placeholder="Admin Password" class="full-width">
            <button onclick="adminApp.login()" class="btn-primary full-width" style="margin-top: 1rem;">Enter</button>
        </div>
    </section>

    <section id="admin-dash" class="hidden">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="sidebar-header">
                <h2>üè† BHouse</h2>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-label">CORE</div>
                <a href="#" onclick="adminApp.showView('dashboard'); return false;" class="nav-link active" data-view="dashboard">
                    <span class="nav-icon">üìä</span> Dashboard
                </a>
                <a href="#" onclick="adminApp.showView('tenants'); return false;" class="nav-link" data-view="tenants">
                    <span class="nav-icon">üë•</span> Tenants
                </a>
                <a href="#" onclick="adminApp.showView('readings'); return false;" class="nav-link" data-view="readings">
                    <span class="nav-icon">üìä</span> Meter Readings
                </a>
                <a href="#" onclick="adminApp.showView('billing'); return false;" class="nav-link" data-view="billing">
                    <span class="nav-icon">üí∞</span> Billing
                </a>
                <a href="#" onclick="adminApp.showView('tickets'); return false;" class="nav-link" data-view="tickets">
                    <span class="nav-icon">üé´</span> Tickets
                </a>
                <a href="#" onclick="adminApp.showView('announcements'); return false;" class="nav-link" data-view="announcements">
                    <span class="nav-icon">üì¢</span> Announcements
                </a>
                
                <div class="nav-label" style="margin-top: 1.5rem;">SECONDARY</div>
                <a href="#" onclick="alert('Reports coming soon'); return false;" class="nav-link">
                    <span class="nav-icon">üìà</span> Reports
                </a>
                <a href="#" onclick="alert('Settings coming soon'); return false;" class="nav-link">
                    <span class="nav-icon">‚öôÔ∏è</span> Settings
                </a>
            </nav>
            <div class="sidebar-footer">
                <button onclick="location.reload()" class="btn-logout full-width">Logout</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="admin-content">
            <div class="admin-header">
                <h2 id="page-title">Dashboard</h2>
            </div>

            <!-- Dashboard View -->
            <div id="view-dashboard" class="admin-view active">
                <!-- KPI Strip -->
                <div class="kpi-strip">
                    <div class="kpi-card">
                        <div class="kpi-label">Occupied Rooms</div>
                        <div class="kpi-value" id="kpi-occupied">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Vacant Rooms</div>
                        <div class="kpi-value" id="kpi-vacant">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Bills Due</div>
                        <div class="kpi-value" id="kpi-bills-due">-</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Open Tickets</div>
                        <div class="kpi-value" id="kpi-tickets">-</div>
                    </div>
                </div>

                <!-- Quick Actions Grid -->
                <div class="dashboard-grid">
                    <div class="card">
                        <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Recent Tenants</h3>
                        <div id="dashboard-tenants" style="font-size: 0.85rem; color: var(--text-muted);">Loading...</div>
                        <button onclick="adminApp.showView('tenants')" class="btn-secondary full-width" style="margin-top: 0.75rem;">View All Tenants</button>
                    </div>
                    <div class="card">
                        <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Unpaid Bills</h3>
                        <div id="dashboard-bills" style="font-size: 0.85rem; color: var(--text-muted);">Loading...</div>
                        <button onclick="adminApp.showView('billing')" class="btn-secondary full-width" style="margin-top: 0.75rem;">View All Bills</button>
                    </div>
                    <div class="card">
                        <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Open Tickets</h3>
                        <div id="dashboard-tickets" style="font-size: 0.85rem; color: var(--text-muted);">Loading...</div>
                        <button onclick="adminApp.showView('tickets')" class="btn-secondary full-width" style="margin-top: 0.75rem;">View All Tickets</button>
                    </div>
                </div>
            </div>

            <!-- Tenants View -->
            <div id="view-tenants" class="admin-view">
                <div class="card">
                    <button onclick="adminApp.openAddTenantModal()" class="btn-primary" style="margin-bottom: 0.75rem;">üë• Add New Tenant</button>
                    <div class="tenants-table-container">
                        <table class="tenants-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Room No</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="tenants-tbody">
                                <tr>
                                    <td colspan="3" style="text-align:center; color:var(--text-muted);">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Meter Readings View -->
            <div id="view-readings" class="admin-view">
                <div class="card">
                    <button onclick="adminApp.openAddReadingModal()" class="btn-primary" style="margin-bottom: 0.75rem; margin-right: 0.5rem;">‚ûï Add Meter Reading</button>
                    <button onclick="adminApp.openReadingsModal()" class="btn-secondary" style="margin-bottom: 0.75rem;">üìÑ View All Readings</button>
                </div>
            </div>

            <!-- Billing View -->
            <div id="view-billing" class="admin-view">
                <div class="card">
                    <div id="admin-billing-list" class="empty-state">Fetching billing records‚Ä¶</div>
                </div>
            </div>

            <!-- Tickets View -->
            <div id="view-tickets" class="admin-view">
                <div class="card">
                    <div id="admin-tickets-list" class="empty-state">Checking for new requests‚Ä¶</div>
                </div>
            </div>

            <!-- Announcements View -->
            <div id="view-announcements" class="admin-view">
                <div class="card">
                    <button onclick="adminApp.openAnnouncementModal()" class="btn-primary">üì¢ Post New Announcement</button>
                </div>
            </div>
        </div>
    </section>
                    <table class="tenants-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Room No</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="tenants-tbody">
                            <tr>
                                <td colspan="3" style="text-align:center; color:var(--text-muted);">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </details>

        <details class="admin-section" open>
            <summary>
                <div>
                    <div class="section-title">üìä Meter Readings</div>
                    <div class="section-desc">Record monthly water and electric usage</div>
                </div>
            </summary>
            <div class="card section-card">
                <button onclick="adminApp.openAddReadingModal()" class="btn-primary full-width" style="margin-bottom: 0.75rem;">‚ûï Add Meter Reading</button>
                <button onclick="adminApp.openReadingsModal()" class="btn-secondary full-width">üìÑ View All Readings</button>
            </div>
        </details>

        <details class="admin-section">
            <summary>
                <div>
                    <div class="section-title">üí∞ Billing Management</div>
                    <div class="section-desc">View and mark tenant payments</div>
                </div>
            </summary>
            <div class="card section-card">
                <div id="admin-billing-list" class="empty-state">Fetching billing records‚Ä¶</div>
            </div>
        </details>

        <details class="admin-section">
            <summary>
                <div>
                    <div class="section-title">üé´ Tickets</div>
                    <div class="section-desc">Review and resolve support requests</div>
                </div>
            </summary>
            <div class="card section-card">
                <div id="admin-tickets-list" class="empty-state">Checking for new requests‚Ä¶</div>
            </div>
        </details>

        <details class="admin-section">
            <summary>
                <div>
                    <div class="section-title">üì¢ Announcements</div>
                    <div class="section-desc">Post updates for tenants</div>
                </div>
            </summary>
            <div class="card section-card">
                <button onclick="adminApp.openAnnouncementModal()" class="btn-primary full-width">üì¢ Post New Announcement</button>
            </div>
        </details>
        </div>
    </section>

    <!-- Add Tenant Modal -->
    <div id="add-tenant-modal" class="modal-overlay" onclick="adminApp.closeAddTenantModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>üë• Add New Tenant</h3>
                <button onclick="adminApp.closeAddTenantModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="tenant-name" placeholder="Full Name" class="full-width">
            </div>
            <div class="form-group">
                <label>Room Number</label>
                <input type="text" id="tenant-room" placeholder="Room No (e.g., 101)" class="full-width">
            </div>
            <div class="form-group">
                <label>4-Digit PIN (for tenant login)</label>
                <input type="password" id="tenant-pin" placeholder="4-Digit PIN" maxlength="4" class="full-width">
            </div>
            <div class="form-group">
                <label>Email (Optional)</label>
                <input type="email" id="tenant-email" placeholder="Email" class="full-width">
            </div>
            <div class="form-group">
                <label>Phone (Optional)</label>
                <input type="tel" id="tenant-phone" placeholder="Phone" class="full-width">
            </div>
            <button onclick="adminApp.addTenant()" class="btn-primary full-width">Save Tenant</button>
        </div>
    </div>

    <!-- Add Meter Reading Modal -->
    <div id="add-reading-modal" class="modal-overlay" onclick="adminApp.closeAddReadingModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>‚ûï Add Meter Reading</h3>
                <button onclick="adminApp.closeAddReadingModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
            </div>
            <div class="form-group">
                <label>Room Number</label>
                <input type="text" id="reading-room" placeholder="Room No (e.g., 101)" class="full-width">
            </div>
            <div class="form-group">
                <label>Reading Date</label>
                <input type="date" id="reading-date" class="full-width">
            </div>
            <div class="form-group">
                <label>Water Reading (m¬≥)</label>
                <input type="number" id="reading-water" placeholder="Water Reading" class="full-width">
            </div>
            <div class="form-group">
                <label>Electric Reading (kWh)</label>
                <input type="number" id="reading-electric" placeholder="Electric Reading" class="full-width">
            </div>
            <button onclick="adminApp.saveReadingFromForm()" class="btn-primary full-width">Save Reading</button>
        </div>
    </div>

    <!-- Post Announcement Modal -->
    <div id="announcement-modal" class="modal-overlay" onclick="adminApp.closeAnnouncementModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>üì¢ Post Announcement</h3>
                <button onclick="adminApp.closeAnnouncementModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="news-title" placeholder="Title (e.g., Water Interruption)" class="full-width">
            </div>
            <div class="form-group">
                <label>Message</label>
                <textarea id="news-body" placeholder="Details..." style="width:100%; height:120px; padding:0.5rem; border: 1px solid var(--border); border-radius: 0.35rem; font-size:0.875rem;"></textarea>
            </div>
            <button onclick="adminApp.postNews()" class="btn-primary full-width">Post Announcement</button>
        </div>
    </div>

    <!-- Readings Modal -->
    <div id="readings-modal" class="modal-overlay" onclick="adminApp.closeReadingsModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>üìÑ Recent Meter Readings</h3>
                <button onclick="adminApp.closeReadingsModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
            </div>
            <div style="display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap;">
                <select id="readings-filter-room" onchange="adminApp.filterReadings()" style="flex:1; min-width:120px; padding:0.5rem; font-size:0.85rem; border-radius:0.35rem; border:1px solid var(--border);">
                    <option value="">All Rooms</option>
                </select>
                <select id="readings-limit" onchange="adminApp.filterReadings()" style="flex:1; min-width:100px; padding:0.5rem; font-size:0.85rem; border-radius:0.35rem; border:1px solid var(--border);">
                    <option value="10">Last 10</option>
                    <option value="20">Last 20</option>
                    <option value="50">Last 50</option>
                    <option value="all">All</option>
                </select>
            </div>
            <div id="readings-list" class="empty-state">Loading recent readings‚Ä¶</div>
        </div>
    </div>

    <!-- Billing Modal -->
    <div id="bill-modal" class="modal-overlay" onclick="adminApp.closeBillModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 550px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>üßæ Create Bill / SOA</h3>
                <button onclick="adminApp.closeBillModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
            </div>
            <div class="form-grid">
                <input type="text" id="bill-room" readonly style="background-color: #f5f5f5; cursor: not-allowed; width:100%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; font-size:1rem;">
                <input type="month" id="bill-month" onchange="adminApp.fetchReadings()">
                <input type="number" id="bill-rental" placeholder="Rental Cost (‚Ç±)">
                <input type="text" id="bill-due" placeholder="Due Date (e.g. Feb 15)">
            </div>
            
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-color); border-radius: 0.35rem; border: 1px solid var(--border);">
                <div style="font-weight: 700; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.02em;">üíß Water Meter</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.75rem;">Previous Reading</label>
                        <input type="number" id="bill-water-prev" readonly style="background: #fff; border: 1px solid var(--border); padding: 0.4rem; border-radius: 0.25rem; width: 100%; font-weight: 600;">
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.75rem;">Current Reading</label>
                        <input type="number" id="bill-water-reading" readonly style="background: #fff; border: 1px solid var(--border); padding: 0.4rem; border-radius: 0.25rem; width: 100%; font-weight: 600;">
                    </div>
                </div>
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff; border-radius: 0.25rem; font-size: 0.8rem;">
                    <strong>Consumption:</strong> <span id="water-consumption">0</span> m¬≥ √ó ‚Ç±<span id="water-rate">50</span>/m¬≥ = <strong style="color: var(--primary);">‚Ç±<span id="water-cost">0</span></strong>
                </div>
            </div>

            <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--bg-color); border-radius: 0.35rem; border: 1px solid var(--border);">
                <div style="font-weight: 700; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.02em;">‚ö° Electric Meter</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.75rem;">Previous Reading</label>
                        <input type="number" id="bill-electric-prev" readonly style="background: #fff; border: 1px solid var(--border); padding: 0.4rem; border-radius: 0.25rem; width: 100%; font-weight: 600;">
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.75rem;">Current Reading</label>
                        <input type="number" id="bill-electric-reading" readonly style="background: #fff; border: 1px solid var(--border); padding: 0.4rem; border-radius: 0.25rem; width: 100%; font-weight: 600;">
                    </div>
                </div>
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff; border-radius: 0.25rem; font-size: 0.8rem;">
                    <strong>Consumption:</strong> <span id="electric-consumption">0</span> kWh √ó ‚Ç±<span id="electric-rate">12</span>/kWh = <strong style="color: var(--primary);">‚Ç±<span id="electric-cost">0</span></strong>
                </div>
            </div>

            <button onclick="adminApp.createBill()" class="btn-primary full-width" style="margin-top:1rem;">Calculate & Send Bill</button>
        </div>
    </div>

    <!-- Tenant Billing History Modal -->
    <div id="tenant-bills-modal" class="modal-overlay" onclick="adminApp.closeTenantBillsModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 id="tenant-bills-title" style="font-size:1rem;">üí∞ Billing History</h3>
                <button onclick="adminApp.closeTenantBillsModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
            </div>
            <div id="tenant-bills-list" style="max-height: 500px; overflow-y: auto;">
                <p>Loading...</p>
            </div>
        </div>
    </div>

    <!-- Edit Tenant Modal -->
    <div id="edit-tenant-modal" class="modal-overlay" onclick="adminApp.closeEditTenantModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>‚úèÔ∏è Edit Tenant</h3>
                <button onclick="adminApp.closeEditTenantModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
            </div>
            <input type="hidden" id="edit-tenant-id">
            <input type="text" id="edit-tenant-name" placeholder="Full Name" style="width:100%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; margin-bottom:0.5rem;">
            <input type="text" id="edit-tenant-room" placeholder="Room No" style="width:100%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; margin-bottom:0.5rem;">
            <input type="password" id="edit-tenant-pin" placeholder="4-Digit PIN" maxlength="4" style="width:100%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; margin-bottom:0.5rem;">
            <input type="email" id="edit-tenant-email" placeholder="Email" style="width:100%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; margin-bottom:0.5rem;">
            <input type="tel" id="edit-tenant-phone" placeholder="Phone" style="width:100%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; margin-bottom:0.5rem;">
            <button onclick="adminApp.updateTenant()" class="btn-primary full-width">Update Tenant</button>
        </div>
    </div>

    <!-- Edit Bill Modal -->
    <div id="edit-bill-modal" class="modal-overlay" onclick="adminApp.closeEditBillModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>‚úèÔ∏è Edit Bill</h3>
                <button onclick="adminApp.closeEditBillModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
            </div>
            <input type="hidden" id="edit-bill-id">
            <div style="margin-bottom:0.5rem;">
                <label style="font-size:0.9rem; color:var(--text-muted); display:block; margin-bottom:0.3rem;">Room & Month</label>
                <input type="text" id="edit-bill-room" readonly style="width:48%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; background:#f5f5f5; margin-right:2%;">
                <input type="text" id="edit-bill-month" readonly style="width:48%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; background:#f5f5f5;">
            </div>
            <input type="number" id="edit-bill-rental" placeholder="Rental Amount" style="width:100%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; margin-bottom:0.5rem;">
            <input type="number" id="edit-bill-water" placeholder="Water Amount" style="width:100%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; margin-bottom:0.5rem;">
            <input type="number" id="edit-bill-electric" placeholder="Electric Amount" style="width:100%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; margin-bottom:0.5rem;">
            <input type="text" id="edit-bill-due" placeholder="Due Date" style="width:100%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; margin-bottom:0.5rem;">
            <select id="edit-bill-status" style="width:100%; padding:0.8rem; border:1px solid var(--border); border-radius:8px; margin-bottom:0.5rem;">
                <option value="unpaid">Unpaid</option>
                <option value="paid">Paid</option>
            </select>
            <button onclick="adminApp.updateBill()" class="btn-primary full-width">Update Bill</button>
        </div>
    </div>

    <script src="admin.js"></script>
</body>
</html>